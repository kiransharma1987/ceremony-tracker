// Prisma schema for Ceremony Expense Tracker
// Database: MySQL (TiDB Cloud Serverless)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Product model - represents an event (ceremony, wedding, etc.)
model Product {
  id            String   @id @default(uuid())
  name          String   // "Padmamma's First Year", "John's Wedding", etc.
  type          String   // CEREMONY, WEDDING, TEAM_DINNER, SHARED_APARTMENT, TRIP
  description   String?  @db.Text
  currency      String   @default("â‚¹") // Currency symbol
  overallBudget Decimal  @default(0) @map("overall_budget") @db.Decimal(10, 2)
  isClosed      Boolean  @default(false) @map("is_closed")
  closedAt      DateTime? @map("closed_at")
  
  // Configuration - which tabs/features are enabled
  enableDashboard     Boolean @default(true) @map("enable_dashboard")
  enableExpenses      Boolean @default(true) @map("enable_expenses")
  enableContributions Boolean @default(true) @map("enable_contributions")
  enableDeposits      Boolean @default(true) @map("enable_deposits")
  enableBudget        Boolean @default(true) @map("enable_budget")
  enableReports       Boolean @default(true) @map("enable_reports")
  enableSettlement    Boolean @default(true) @map("enable_settlement")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations - all data is discrete per product
  users        User[]
  expenses     Expense[]
  contributions Contribution[]
  budgets      Budget[]
  deposits     Deposit[]

  @@index([createdAt])
  @@map("products")
}

// User model for authentication
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  name         String
  displayName  String?  @map("display_name") // Override name per product
  role         UserRole @default(ATTENDEE) @map("role")
  isActive     Boolean  @default(true) @map("is_active")
  
  // Product association
  productId    String?  @map("product_id") // NULL for SUPER_ADMIN only
  product      Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([productId])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  ORGANIZER
  ATTENDEE
  SPONSOR
}

// Expense model - expenses are discrete per product
model Expense {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  title     String
  category  String   // Food & Catering, Priest Renumeration, etc.
  amount    Decimal  @db.Decimal(10, 2)
  paidBy    String   @map("paid_by") // HNK, HNP, HNS, HNM or participant ID
  date      DateTime
  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@index([date])
  @@map("expenses")
}

// Contribution model (from sister HNU and relatives)
model Contribution {
  id              String   @id @default(uuid())
  productId       String   @map("product_id")
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  contributorName String   @map("contributor_name")
  relationship    String   // Sister (HNU), Relative, Well-Wisher
  amount          Decimal  @db.Decimal(10, 2)
  date            DateTime
  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@map("contributions")
}

// Category Budget model
model Budget {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  category  String
  amount    Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([productId, category])
  @@index([productId])
  @@map("budgets")
}

// Note: Settings are now part of Product model (overallBudget, isClosed, closedAt)

// Deposit model - Brothers depositing money with treasurer (discrete per product)
model Deposit {
  id          String   @id @default(uuid())
  productId   String   @map("product_id")
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  depositedBy String   @map("deposited_by") // HNK, HNP, HNS, HNM or participant ID
  amount      Decimal  @db.Decimal(10, 2)
  date        DateTime
  notes       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@map("deposits")
}
